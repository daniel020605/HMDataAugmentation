Vulkan平台
业务流程
基于Vulkan图形API平台，集成超帧内插模式的主要业务流程如下：
 用户进入超帧适用的游戏场景。 游戏应用调用HMS_FG_CreateContext_VK接口创建超帧上下文实例。如超帧上下文实例创建失败，则无需进入步骤6到步骤10的预测帧、真实帧交替渲染送显的循环流程，只需逐帧对场景进行渲染送显即可。 游戏应用调用接口配置超帧实例属性。包括调用HMS_FG_SetAlgorithmMode_VK（必选）设置超帧算法模式并选择内插模式；调用HMS_FG_SetResolution_VK（必选）设置超帧输入输出图像分辨率；调用HMS_FG_SetCvvZSemantic_VK（可选）设置齐次裁剪空间Z/W范围及深度测试函数；调用HMS_FG_SetImageFormat_VK（可选）设置超帧输入输出图像格式；如果颜色缓冲区相对深度模板缓冲区基于y轴翻转180度，则调用HMS_FG_SetDepthStencilYDirectionInverted_VK（可选）设置翻转状态。 游戏应用调用HMS_FG_Activate_VK接口激活超帧上下文实例。 游戏应用调用HMS_FG_CreateImage_VK接口创建真实渲染帧颜色缓冲区图像实例、深度模板缓冲区图像实例、预测帧缓冲区图像实例。该接口将游戏应用中的VkImage、VkImageView图像资源和超帧算法实现之间建立关联。 游戏应用调用HMS_FG_Dispatch_VK接口并传入历史真实渲染帧颜色信息、深度信息、相机矩阵信息，生成预测帧，并更新预测帧缓冲区。 预测帧绘制UI并送显。 绘制缓存中的上一帧真实渲染帧，并绘制UI。 上一帧真实渲染帧送显。 渲染游戏场景获取真实渲染帧，缓存真实渲染帧颜色信息、深度信息、相机矩阵等信息，用于后续超帧预测。由于内插模式真实帧需要等待前一帧预测帧绘制并送显后再送显，因此此处缓存一帧真实帧信息。跳转至序号5继续执行，直到退出游戏场景。 用户退出超帧适用的游戏场景。 游戏应用调用HMS_FG_DestroyContext_VK接口销毁超帧上下文实例并释放内存资源。 
开发步骤
本节阐述基于Vulkan图形API平台的超帧调用示例，详细代码请参考图形开发Sample（超帧Vulkan）。
 引用Graphics Accelerate Kit超帧头文件：frame_generation_vk.h。// 引用超帧frame_generation_vk.h头文件\n#include <graphics_game_sdk/frame_generation_vk.h> 编写CMakeLists.txt。find_library(\n    # Sets the name of the path variable.\n    framegeneration-lib\n    # Specifies the name of the NDK library that you want CMake to locate.\n    libframegeneration.so\n)\nfind_library(\n    # Sets the name of the path variable.\n    vulkan-lib\n    # Specifies the name of the NDK library that you want CMake to locate.\n    vulkan\n)\n\ntarget_link_libraries(entry PUBLIC\n    ${framegeneration-lib} ${vulkan-lib}\n) 调用HMS_FG_CreateContext_VK接口创建超帧上下文实例。如果返回nullptr，则说明超帧上下文实例创建失败，或当前硬件设备不支持开启超帧。// 变量声明\nVkInstance vkInstance = VK_NULL_HANDLE;\nVkPhysicalDevice vkPhysicalDevice = VK_NULL_HANDLE;\nVkDevice vkDevice = VK_NULL_HANDLE;\n\n// 创建超帧上下文实例\nFG_ContextDescription_VK contextDescription{};\ncontextDescription.vkInstance = vkInstance;\ncontextDescription.vkPhysicalDevice = vkPhysicalDevice;\ncontextDescription.vkDevice = vkDevice;\ncontextDescription.framesInFlight = 1;\ncontextDescription.fnVulkanLoaderFunction = vkGetInstanceProcAddr;\nFG_Context_VK* m_context = HMS_FG_CreateContext_VK(&contextDescription);\nif (m_context == nullptr) {\n    return;\n} 调用超帧实例属性配置接口，超帧算法模式选择内插模式。// 初始化超帧接口调用错误码\nFG_ErrorCode errorCode = FG_SUCCESS;\n\n// 超帧算法模式\nFG_AlgorithmModeInfo aInfo{};\naInfo.predictionMode = FG_PREDICTION_MODE_INTERPOLATION;                  // 内插模式\naInfo.meMode = FG_ME_MODE_BASIC;                                          // 运动估计基础模式\nerrorCode = HMS_FG_SetAlgorithmMode_VK(m_context, &aInfo);                // [必选] 设置超帧算法模式\nif (errorCode != FG_SUCCESS) {\n    return;\n}\n\n// 真实帧颜色缓冲区分辨率\nFG_Dimension2D inputColorResolution{};                                    \ninputColorResolution.width = 1280;                                        // 真实帧颜色缓冲区图像宽度\ninputColorResolution.height = 720;                                        // 真实帧颜色缓冲区图像高度\n// 真实帧深度模板缓冲区分辨率\nFG_Dimension2D inputDepthStencilResolution{};                             \ninputDepthStencilResolution.width = 1280;                                 // 真实帧深度模板缓冲区图像宽度\ninputDepthStencilResolution.height = 720;                                 // 真实帧深度模板缓冲区图像高度\n// 预测帧分辨率\nFG_Dimension2D outputColorResolution{};                                    \noutputColorResolution.width = 1280;                                       // 预测帧图像宽度\noutputColorResolution.height = 720;                                       // 预测帧图像高度\n// 超帧输入输出图像分辨率\nFG_ResolutionInfo rInfo{};\nrInfo.inputColorResolution = inputColorResolution;\nrInfo.inputDepthStencilResolution = inputDepthStencilResolution;\nrInfo.outputColorResolution = outputColorResolution;\nerrorCode = HMS_FG_SetResolution_VK(m_context, &rInfo);                   // [必选] 设置超帧输入输出图像分辨率\nif (errorCode != FG_SUCCESS) {\n    return;\n}\n\n// [可选] 设置齐次裁剪空间Z/W范围及深度测试模式，接口不调用时默认为FG_CVV_Z_SEMANTIC_ZERO_TO_ONE_FORWARD_Z\nerrorCode = HMS_FG_SetCvvZSemantic_VK(m_context, FG_CVV_Z_SEMANTIC_ZERO_TO_ONE_FORWARD_Z);\nif (errorCode != FG_SUCCESS) {\n    return;\n}\n\n// [可选] 设置超帧输入输出图像格式\nFG_ImageFormat_VK imageFormat{};\nimageFormat.inputColorFormat = VK_FORMAT_R8G8B8A8_UNORM;\nimageFormat.inputDepthStencilFormat = VK_FORMAT_D24_UNORM_S8_UINT;\nimageFormat.outputColorFormat = VK_FORMAT_R8G8B8A8_UNORM;\nerrorCode = HMS_FG_SetImageFormat_VK(m_context, &imageFormat);\nif (errorCode != FG_SUCCESS) {\n    return;\n}\n\n// [可选] 当颜色缓冲区相对深度模板缓冲区基于y轴翻转180度时，设置第二个参数为true，接口不调用时默认为false\nerrorCode = HMS_FG_SetDepthStencilYDirectionInverted_VK(m_context, true);\nif (errorCode != FG_SUCCESS) {\n    return;\n} 调用HMS_FG_Activate_VK接口激活超帧上下文实例。// 激活超帧上下文实例\nerrorCode = HMS_FG_Activate_VK(m_context);\nif (errorCode != FG_SUCCESS) {\n    return;\n} 调用HMS_FG_CreateImage_VK接口创建真实渲染帧颜色缓冲区图像实例、深度模板缓冲区图像实例、预测帧缓冲区图像实例。// 变量声明\nVkImage inputColorImage = VK_NULL_HANDLE;\nVkImageView inputColorImageView = VK_NULL_HANDLE;\nVkImage inputDepthStencilImage = VK_NULL_HANDLE;\nVkImageView inputDepthStencilImageView = VK_NULL_HANDLE;\nVkImage outputColorImage = VK_NULL_HANDLE;\nVkImageView outputColorImageView = VK_NULL_HANDLE;\n\n// 创建真实帧颜色缓冲区图像实例\nFG_Image_VK* inputColor = HMS_FG_CreateImage_VK(m_context, inputColorImage, inputColorImageView);\nif (!inputColor) {\n    return;\n}\n// 创建真实帧深度模板缓冲区图像实例\nFG_Image_VK* inputDepthStencil = HMS_FG_CreateImage_VK(m_context, inputDepthStencilImage, inputDepthStencilImageView);\nif (!inputDepthStencil) {\n    return;\n}\n// 创建预测帧缓冲区图像实例\nFG_Image_VK* outputColor = HMS_FG_CreateImage_VK(m_context, outputColorImage, outputColorImageView);\nif (!outputColor) {\n    return;\n} 游戏运行中，真实帧和预测帧交替渲染并送显。渲染真实帧时，缓存颜色信息、深度信息和相机矩阵等属性信息。渲染预测帧时，需调用HMS_FG_Dispatch_VK接口并传入上一帧真实帧属性信息，指定预测帧缓冲区索引，生成预测帧，最终更新预测帧缓冲区内存。// 帧计数\nuint32_t frameNum = 0;\n\n// 帧循环\nwhile (true) {\n    frameNum += 1;\n    if ((frameNum & 1) != 0) { // 预测帧渲染阶段    \n        // 设置预测帧生成前真实帧颜色缓冲区同步状态\n        FG_ImageSync_VK inputColorInitImageSync{};\n        inputColorInitImageSync.stages = VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT;\n        inputColorInitImageSync.layout = VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL;\n        inputColorInitImageSync.accessMask = VK_ACCESS_COLOR_ATTACHMENT_WRITE_BIT;\n\n        // 设置预测帧生成后真实帧颜色缓冲区同步状态\n        FG_ImageSync_VK inputColorFinalImageSync{};\n        inputColorFinalImageSync.stages = VK_PIPELINE_STAGE_TRANSFER_BIT;\n        inputColorFinalImageSync.layout = VK_IMAGE_LAYOUT_TRANSFER_SRC_OPTIMAL;\n        inputColorFinalImageSync.accessMask = VK_ACCESS_TRANSFER_READ_BIT;\n\n        // 创建真实帧颜色缓冲区图像属性实例\n        FG_ImageInfo_VK inputColorImageInfo{};\n        inputColorImageInfo.image = inputColor;\n        inputColorImageInfo.initialSync = inputColorInitImageSync;\n        inputColorImageInfo.finalSync = inputColorFinalImageSync;\n\n        // 设置预测帧生成前深度模板缓冲区同步状态\n        FG_ImageSync_VK depthInitImageSync{};\n        depthInitImageSync.stages = VK_PIPELINE_STAGE_LATE_FRAGMENT_TESTS_BIT;\n        depthInitImageSync.layout = VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL;\n        depthInitImageSync.accessMask = VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_WRITE_BIT;\n\n        // 设置预测帧生成后深度模板缓冲区同步状态\n        FG_ImageSync_VK depthFinalImageSync{};\n        depthFinalImageSync.stages = VK_PIPELINE_STAGE_LATE_FRAGMENT_TESTS_BIT;\n        depthFinalImageSync.layout = VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL;\n        depthFinalImageSync.accessMask = VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_READ_BIT;\n\n        // 创建真实帧深度模板缓冲区图像属性实例\n        FG_ImageInfo_VK depthImageInfo{};\n        depthImageInfo.image = inputDepthStencil;\n        depthImageInfo.initialSync = depthInitImageSync;\n        depthImageInfo.finalSync = depthFinalImageSync;\n\n        // 设置预测帧生成前预测帧缓冲区同步状态\n        FG_ImageSync_VK outputColorInitImageSync{};\n        outputColorInitImageSync.stages = VK_PIPELINE_STAGE_ALL_GRAPHICS_BIT;\n        outputColorInitImageSync.layout = VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL;\n        outputColorInitImageSync.accessMask = VK_ACCESS_SHADER_WRITE_BIT;\n\n        // 设置预测帧生成后预测帧缓冲区同步状态\n        FG_ImageSync_VK outputColorFinalImageSync{};\n        outputColorFinalImageSync.stages = VK_PIPELINE_STAGE_TRANSFER_BIT;\n        outputColorFinalImageSync.layout = VK_IMAGE_LAYOUT_TRANSFER_SRC_OPTIMAL;\n        outputColorFinalImageSync.accessMask = VK_ACCESS_TRANSFER_READ_BIT;\n\n        // 创建预测帧缓冲区图像属性实例\n        FG_ImageInfo_VK outputColorImageInfo{};\n        outputColorImageInfo.image = outputColor;\n        outputColorImageInfo.initialSync = outputColorInitImageSync;\n        outputColorImageInfo.finalSync = outputColorFinalImageSync;\n\n        // 帧生成属性配置结构体\n        FG_DispatchDescription_VK dispatchDescription{};\n        // 传入真实渲染帧颜色缓冲区属性信息\n        dispatchDescription.inputColorInfo = inputColorImageInfo;\n        // 传入真实渲染帧深度模板缓冲区属性信息\n        dispatchDescription.inputDepthStencilInfo = depthImageInfo;\n        // 传入预测帧缓冲区属性信息\n        dispatchDescription.outputColorInfo = outputColorImageInfo;\n\n        // 变量声明\n        FG_Mat4x4 preViewProj;\n        FG_Mat4x4 preInvViewProj;\n        VkCommandBuffer vkCommandBuffer = VK_NULL_HANDLE;\n\n        // 传入上一帧真实渲染帧视图投影矩阵\n        dispatchDescription.viewProj = preViewProj;\n        // 传入上一帧真实渲染帧视图投影逆矩阵\n        dispatchDescription.invViewProj = preInvViewProj;\n        // 传入用于录入超帧绘制指令的命令缓冲区句柄\n        dispatchDescription.vkCommandBuffer = vkCommandBuffer;\n        // 传入当前帧序号\n        dispatchDescription.frameIdx = 0;\n\n        // 生成预测帧，更新预测帧缓冲区的内存\n        errorCode = HMS_FG_Dispatch_VK(m_context, &dispatchDescription);\n        if (errorCode != FG_SUCCESS) {\n            return;\n        }\n        switch (errorCode) {\n            case FG_SUCCESS: { // 生成预测帧成功\n                // 绘制预测帧\n                // ...\n\n                // 绘制UI\n                // ...\n\n                // 预测帧送显\n                // ...\n                break;\n            }\n            case FG_COLLECTING_PREVIOUS_FRAMES:\n                // 传入真实帧数量未达到固定阈值，无预测帧生成，内插模式传入真实帧数量<3时返回该状态码，此时不要将预测帧送显\n                break;\n            default:\n                // 预测帧生成失败\n                return;\n        }\n    } else { // 真实帧渲染阶段            \n        // 绘制缓存中的上一帧真实帧\n        // ...\n\n        // 绘制UI\n        // ...\n        \n        // 渲染当前帧渲染画面，缓存颜色、深度、相机矩阵等信息，用于下一帧预测帧生成\n        // ...\n       \n        // 送显缓存中的上一帧真实帧\n        // ...\n    }\n} 调用HMS_FG_DestroyContext_VK接口销毁超帧实例，释放内存资源。// 销毁超帧上下文实例并释放内存资源\nerrorCode = HMS_FG_DestroyContext_VK(&m_context);\nif (errorCode != FG_SUCCESS) {\n    return;\n} 
